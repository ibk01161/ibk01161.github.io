---
layout: single
title:  "[CHAP7] 보안 관련 서비스 - 3"
categories: AWS
---

# 03. 계정 내 작업 이력 기록

## * AWS CloudTrail이란

AWS 사용 현황을 관리하는데 있어서 '누가, 언제, 어느 곳에 무엇을 했는지' 를 기록하는 것은 매우 중요  
**AWS CloudTrail(CloudTrail)**은 AWS 계정을 만들 때부터 자동으로 모든 작업을 기록하는 서비스  
관리 콘솔이나 프로그램에서의 작업, AWS 서비스에서 수행한 모든 작업을 기록  
이 이력을 통해 AWS에서 누가 어떤 작업을 했는지 자세한 내용을 파악할 수 있어 사용자가악의적인 조작을 하거나 프로그램 문제로 발생한 설정 변경 등을 조사할 수 있음  
로그는 기본적으로 90일 동안 저장되지만 설정에 따라 S3와 같이 별도의 스토리지에 파일로 저장해 그 이상 로그를 저장할 수 있음  
S3에 저장하는 로그 파일은 **트레일(trail)**이라고 하며 암호화돼 보관됨, 보관된 로그의 변조를 막는 기능도 있어 문제가 발생했을 때 당시 조작기록을 증명하기 위한 중요한 기록으로 사용  
CloudTrail은 AWS의 감시 카메라라고 할 수 있음  


## * 기록되는 내용

CloudTrail에 저장되는 내용은 **관리 콘솔**과 **API를 통한 조작 이력**, 이에 해당되지 않는 조작은 기록되지 않음  
예를 들어 SSH 또는 원격 데스크톱으로 직접 EC2에 접속해 작업을 수행한다면 그 내용은 CloudTrail에 기록되지 않음  

* 기록되는 조작 내용
1. 관리 이벤트 : 관리 콘솔에 로그인, EC2 인스턴스나 S3 버킷, Lambda 함수와 같은 AWS 자원의 생성, 수정, 삭제와 같은 조작  
2. 데이터 이벤트 : S3 버킷 관련 작업(파일 생성, 편집, 삭제), Lambda 함수 실행과 같은 AWs 자원에 대한 조작
3. 인사이트 이벤트 : AWS 계정의 행동 탐지(평소와 다른 조작), 일반 CloudTrail 로그를 통해 사용 패턴을 학습하고 거기에서 벗어난 조작 패턴을 탐지

기본적으로 **관리 이벤트**만 기록하게 설정돼 있지만, **데이터 이벤트**, **인사이트 이벤트**를 저장하려면 설정을 변경해야 함  
**관리 이벤트**는 CloudTrail에 저장된 90일간의 로그와 첫 번재 트레일 출력에 대해서는 요금이 발생하지 않음  
두 번재 트레일 출력부터는 이벤트 수에 따라 요금이 발생함, 서울 리전의 요금은 관리 이벤트 10만 건당 2.00USD임  
**데이터 이벤트**는 CLoudTrail에 저장되지 않고 로그로 출력만 할 수 있음, 관리 이벤트와 마찬가지로 발생한 이벤트 수에 따라 요금이 발생, 서울 리전에서는 이벤트 10만 건당 0.10USD  
**인사이트 이벤트**는 탐지된 비정상적인 조작만 트레일로 출력, 분석된 이벤트 수에 따른 요금이 발생, 서울 리전의 요금은 분석된 이벤트 10만 건당 0.35USD  


## * 트레일 출력

CloudTrail은 로그를 트레일(Trail-추적)해 S3나 CloudWatch Logs로 출력할 수 있음, 두 서비스 모두 저장 비용이 발생하지만 출력된 로그를 무기한으로 저장할 수 있음  
S3에 저장하는 경우 **파일 형태**로 저장됨, 감시 카메라로 비유하면 촬영된 동영상 파일을 대용량 저장소에 저장하는 것, 작업 내역은 해당 파일 내용을 열람해서 확인할 수 있음  
저장된 파일이 악의적인 사용자에게 변조될 수 있으므로 CloudTrail이 저장한 파일의 **무결성 검사 파일(다이제스트)**을 출력할 수도 있음  
CloudWatch Logs에 저장하는 경우 **스트림 형식**으로 저장, 스트림이란 로그의 내용이 순차적으로 저장되는 것으로 감시 카메라로 비유한다면 촬영된 영상이 재생되는 상태  
작업 기록을 확인할 때는 거의 실시간으로 전송되는 **스트림 내용**을 확인하거나 과거에 기록된 스트림 내용을 CloudWatch Logs 관리 화면에서 검색함  
CloudWatch Logs에는 로그 내용을 확인하고 특정 문자열을 찾을 때 이벤트를 발생시키는 기능이 있음, 이 기능을 이용해 특정 조작이 발생했을 때 사용자에게 알림을 보낼 수도 있음  


> 참고 : 그림과 작동 원리로 쉽게 이해하는 AWS 구조와 서비스